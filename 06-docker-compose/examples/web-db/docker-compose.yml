# ===========================================
# Web + Database Example
# ===========================================
# A complete web stack with:
# - Nginx web server
# - Adminer database admin
# - MariaDB database
# ===========================================

services:
  # ===========================================
  # Web Server
  # ===========================================
  web:
    image: nginx:alpine
    container_name: web
    ports:
      - "${WEB_PORT:-8080}:80"
    volumes:
      # Static HTML files
      - ./html:/usr/share/nginx/html:ro
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================
  # Database Admin UI
  # ===========================================
  adminer:
    image: adminer:latest
    container_name: adminer
    ports:
      - "${ADMINER_PORT:-8081}:8080"
    environment:
      # Default database server
      ADMINER_DEFAULT_SERVER: db
    networks:
      - app-network
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

  # ===========================================
  # MariaDB Database
  # ===========================================
  db:
    image: mariadb:${MARIADB_VERSION:-latest}
    container_name: db
    environment:
      # Root password (required)
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      # Create database on startup
      MARIADB_DATABASE: ${DB_NAME}
      # Create user on startup
      MARIADB_USER: ${DB_USER}
      MARIADB_PASSWORD: ${DB_PASSWORD}
    volumes:
      # Persist database data
      - db-data:/var/lib/mysql
      # Initialization scripts (run once on first start)
      - ./init:/docker-entrypoint-initdb.d:ro
    networks:
      - app-network
    restart: unless-stopped
    # Health check for MariaDB
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

# ===========================================
# Networks
# ===========================================
networks:
  app-network:
    driver: bridge

# ===========================================
# Volumes
# ===========================================
volumes:
  db-data:
    driver: local
